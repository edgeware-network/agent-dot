OS="$(uname)"

if [ "$OS" = "Linux" ] || [ "$OS" = "Darwin" ]; then
  echo ""
  echo "ğŸ’» Unix-based system detected. Checking @polkadot-api/descriptors path..."

  if grep -q '"@polkadot-api/descriptors": "file:.papi/descriptors"' package.json; then
    echo "âŒ Invalid path format detected in package.json for @polkadot-api/descriptors."
    echo "ğŸ›   Expected: 'file:.papi\\descriptors'"
    echo "ğŸ”’ Commit aborted to prevent cross-platform compatibility issues."
    echo "ğŸ’¡ Run 'pnpm revert:path' to correct the path for Windows."
    exit 1
  else
    echo "âœ… Path format is correct: using backslashes for Windows."
  fi

  if grep -q "specifier: file:.papi/descriptors" pnpm-lock.yaml; then
    echo "âŒ Invalid path format detected in pnpm-lock.yaml for @polkadot-api/descriptors."
    echo "ğŸ›   Expected: 'specifier: file:.papi\descriptors'"
    echo "ğŸ”’ Commit aborted to prevent cross-platform compatibility issues."
    echo "ğŸ’¡ Run 'pnpm revert:path' to correct the path for Windows."
    exit 1
  else
    echo "âœ… Path format is correct: using backslash for Windows."
  fi
  else
  echo ""
  echo "ğŸªŸ Windows detected. Skipping @polkadot-api/descriptors path check."
fi

# ğŸ” Run lint-staged
echo ""
echo "ğŸ” Running lint-staged..."
pnpm lint-staged

if [ $? -ne 0 ]; then
  echo "âŒ lint-staged failed. Fix the issues before committing."
  exit 1
else
  echo "âœ… lint-staged passed."
fi

# ğŸš¨ Run ESLint in production mode
echo ""
echo "ğŸš¨ Running production lint (ESLint)..."
pnpm lint:prod

if [ $? -ne 0 ]; then
  echo "âŒ ESLint failed in production mode. Please fix lint errors."
  exit 1
else
  echo "âœ… ESLint passed."
fi

# ğŸ› ï¸  TypeScript type check
echo ""
echo "ğŸ› ï¸  Running TypeScript type check..."
pnpm tsc

if [ $? -ne 0 ]; then
  echo "âŒ TypeScript type check failed. Fix type errors before committing."
  exit 1
else
  echo "âœ… TypeScript check passed."
fi

# ğŸ—ï¸  Build project
echo ""
echo "ğŸ—ï¸  Building project..."
pnpm build

if [ $? -ne 0 ]; then
  echo "âŒ Build failed. Fix build errors before committing."
  exit 1
else
  echo "âœ… Build succeeded."
fi

# ğŸ‰ Final success message
echo ""
echo "ğŸ‰ All checks passed. Proceeding with commit."
